# Architecture Guide
This document outlines the technical architecture for a command-line interface (CLI) tool, written in TypeScript. It's designed to automatically generate high-quality commit messages for staged changes in a Git repository. It calls a Large Language Model (LLM) to generate these messages, and adds an identifying footer to maintain a record of AI assistance.

## 1. Goal
The primary goal is to provide a self-contained tool that analyzes staged changes in a Git repository and creates a commit with an LLM-generated message. The tool gathers context from the staged changes (diffs, diffstats), uses an LLM to generate a commit message, validates it, and appends a standard footer (program name, version, timestamp). It then creates a commit, providing developers with well-crafted commit messages without having to write them manually.

## 2. Core Components

### CLI Interface (lib_arg_infer)
- Handles parsing all command-line arguments and options (e.g., LLM config, debug settings).
- Makes program name and version (e.g., from package.json) available to the application logic.
- Provides help messages and usage instructions.

### Git Access and Utilities
- Uses simple-git to provide access to the Git repository and its operations.
- Provides functions to validate the repository and check for staged changes.
- Retrieves information about the current branch and recent commits.

### Git Diff Calculation and Formatting
- Calculates diffs for staged changes and formats in standard diff format.
- Calculates a diffstat for staged changes to provide a summary overview.

### Footer Manager
- Generates message footers to indicate AI-assisted commit messages.
- Adds the footer to the message generated by the LLM with suitable whitespace.
- Includes program name, version, timestamp, and LLM model used.

### Git Commit Message Generator
- Takes the following as input:
  - The staged changes (diff and diffstat).
  - LLM configuration (provider, model) from CLI args.
  - System prompt for setting LLM context.
  - Current program name and version.
- Dynamically generates the LLM Prompt: Assembles a prompt with sections for diffstat, detailed diff.
- Creates a system prompt: Defines the role and task for the LLM.
- Interacts with LLM: Calls the LLM API via the Vercel AI SDK with the appropriate provider (OpenAI, Anthropic, Google Gemini), handles errors.
- Receives and Parses Response: Gets the generated text message.
- Performs Validation: Applies automated checks to the LLM message. If validation fails, handles it according to configured strategy (error, default). Let the validated message be llm_message.
- Appends Footer: Creates the standard footer string (e.g., \n\nGenerated by: <ProgramName> v<Version> (<Timestamp>)). Appends this footer to the llm_message.
- Returns the combined message (llm_message + footer).

### Git Commit Creator
- Takes the generated commit message and creates a new commit with the staged changes.
- Uses simple-git to perform the commit operation.

### User Confirmation Module
- Always displays the generated commit message to the user before proceeding.
- Provides an interactive confirmation prompt allowing the user to:
  - Accept the message and create the commit
  - Cancel the operation entirely
- When no staged changes are detected, provides a clear status message.

### Logging/Reporting
- Outputs the LLM-generated commit message.
- Reports the final outcome, including successful commit creation.
- Uses color-coded action messages for clear status communication.
- Includes debug channels for LLM inputs, outputs.
- Logs errors clearly.

## 3. Workflow

1. **Initialization**: User runs command, provides config.
2. **Argument Parsing**: lib_arg_infer parses args and options. Get program name/version.
3. **Repository Validation**: Validate repo via simple-git.
4. **Check for Staged Changes**: Verify that changes have been staged for commit.
5. **Gather Context**:
   - Retrieve branch information and recent commit messages.
   - Calculate diff and diffstat for staged changes.
6. **Generate Commit Message**:
   - Construct prompt incorporating diff details and context.
   - Call LLM API with appropriate provider.
   - Validate the generated message.
   - Append footer with program name, version, timestamp.
7. **User Confirmation**:
   - Display the generated message.
   - Provide options to accept, edit, or cancel.
   - If user edits the message, present the edited version for final confirmation.
8. **Create Commit**:
   - Create a commit with the accepted message (original or user-edited).
9. **Reporting**: Report success with appropriate message confirming the commit was created.

## 4. Technology Stack
- TypeScript
- Node.js (v22+)
- lib_arg_infer
- simple-git
- Vercel AI SDK (@ai-sdk/* packages)
- Biome for linting and formatting
- Build tools

## 5. Message Generation Logic
- Includes logic for formatting and appending the footer to generated messages.
- Includes the LLM model name in the footer for traceability.
- Support for multiple LLM providers through the Vercel AI SDK (OpenAI, Anthropic, and Google Gemini, with ability to add more).
- Separation of concerns with system prompts being passed from application layer.
- Validation logic for LLM output.
- Debug options to view LLM inputs (--debug-llm-inputs) and outputs (--debug-llm-outputs).

## 6. User Experience and Safety
- Required interactive confirmation showing the generated message
- Options to accept, or cancel the commit
- Message validation to ensure quality
- LLM API error handling with detailed messages
- Environment variable fallbacks for API keys
- Graceful handling of empty staged changes
- Clear user feedback during each step of the process

### Key Features
- **Staged Changes Analysis**: Accurately analyzes what's been staged for commit.
- **Context Awareness**: Incorporates branch information and recent commits for better messages.
- **Quality Messages**: Uses LLM to generate detailed, descriptive commit messages.
- **Interactive Workflow**: Allows users to review, edit, or cancel before committing.
- **Footer Format**: Includes program name, version, timestamp, and LLM model used.
- **Error Handling**: Prevents commits when errors are encountered and provides helpful guidance.
- **Prompt Optimization**: Streamlines prompts by only including relevant context.
- **Message Editing**: Supports user edits to the generated message before final commit.
- **Diffstat Summary**: Includes diffstat summaries for quick overview of changes.

### Future Considerations
- **Template Support**: Allow users to provide custom templates for commit messages.
- **Conventional Commits**: Add support for generating messages in Conventional Commits format.
- **Pre-commit Hook**: Enable integration as a pre-commit hook for automatic message generation.
- **Message History**: Store history of generated messages for user reference.
- **Multi-language Support**: Enhanced prompting for repositories with multiple programming languages.
- **Test Coverage**: Comprehensive tests to ensure robustness across edge cases.
- **LLM Provider Expansion**: Easy extension with additional LLM providers through the Vercel AI SDK.
